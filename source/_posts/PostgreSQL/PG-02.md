---
title: PostgreSQL 02 - 配置
date: 2024-07-23 14:00:00
updated: 2024-07-24 14:35:08
tags:
  - DB
  - PostgreSQL
categories:
  - [DB, PostgreSQL]
---

&emsp;&emsp;PostgreSQL: The World\'s Most Advanced Open Source Relational Database.

<!-- more -->

## 客户端身份验证

&emsp;&emsp;当客户端应用程序连接到数据库服务器时，它会指定希望以哪个 PostgreSQL 数据库用户名进行连接，这与用户以特定用户身份登录 Unix 计算机的方式非常相似。PostgreSQL 数据库用户名在逻辑上与服务器运行所在的操作系统的用户名分离。

### pg_hba.conf 文件

&emsp;&emsp;客户端认证由一个配置文件控制，传统上命名为`pg_hba.conf`，并存储在数据库集群的数据目录中。`pg_hba.conf`文件的一般格式是一组记录，每行一个记录。空白行将被忽略，`#`注释字符之后的任何文本也将被忽略。可以通过在行尾加上反斜杠来将记录续到下一行。每个认证记录指定一个连接类型、一个客户端 IP 地址范围 (如果与连接类型相关)、一个数据库名称、一个用户名以及用于匹配这些参数的连接的认证方法。

```
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            md5
# IPv6 local connections:
host    all             all             ::1/128                 md5
# Allow replication connections from localhost, by a user with the
# replication privilege.
local   replication     all                                     trust
host    replication     all             127.0.0.1/32            md5
host    replication     all             ::1/128                 md5
```

&emsp;&emsp;注释说的比较清晰，这里所说的 USER 是 PG 数据中有 LOGIN 权限的 ROLE，而不是系统用户。METHOD 字段用于控制客户端以该 USER 登录服务器时的验证方式：`trust`表示无需密码即可连接，如果要求客户端连接时输入 USER 的密码，则 METHOD 应为`password`，`md5`或`scram-sha-256`。但实际常用的方式应该是后两种，因为`password`会使密码以明文的形式被传递。

&emsp;&emsp;如果要求客户端输入密码，则 USER 的密码不能为 NULL，否则所有密码都无法通过验证。

### postgresql.conf 文件

&emsp;&emsp;postgresql.conf 是另一个重要的配置文件，它包含了很多配置项目，这里只列两条：

```
listen_addresses = 'localhost'          # what IP address(es) to listen on;
                                        # comma-separated list of addresses;
                                        # defaults to 'localhost'; use '*' for all
                                        # (change requires restart)
#port = 5432                            # (change requires restart)
```

&emsp;&emsp;这两个配置项用于控制服务器监听地址和端口，`localhost`表示 PG 只会监听本机地址，外部主机将无法连接服务器。将其修改为`*`以允许外部主机连接服务器。

## 角色

&emsp;&emsp;PostgreSQL 使用角色的概念管理数据库访问权限。根据角色的设置方式，可以将角色视为数据库用户或数据库用户组。角色可以拥有数据库对象 (如表和函数），并且可以将这些对象上的权限分配给其他角色，以控制谁可以访问哪些对象。

&emsp;&emsp;角色的概念包含了`用户`和`组`的概念。在 8.1 之前的 PostgreSQL 版本中，用户和组是不同类型的实体，但现在只有角色。任何角色都可以充当用户、组或两者。

### 管理角色

&emsp;&emsp;从概念上讲，数据库角色与操作系统用户完全分离。在实践中，保持对应关系可能很方便，但这并不是必需的。数据库角色在整个数据库集群安装中是全局的(而不是针对每个单独的数据库）。

1. 创建角色

```sql
CREATE ROLE name [LOGIN];
```

2. 删除角色

```sql
DROP ROLE name;
```

&emsp;&emsp;PG 提供了以上两个语句的 shell 包装器：

```bash
createuser name
dropuser name
```

3. 查询角色

&emsp;&emsp;查询数据库集群中现有的角色：

```sql
SELECT rolname FROM pg_roles;
```

&emsp;&emsp;查询有登录权限的角色：

```sql
SELECT rolname FROM pg_roles WHERE rolcanlogin;
```

&emsp;&emsp;查询角色也可以使用 PG 的元命令：

```sql
\du
```

### 角色属性

&emsp;&emsp;数据库角色可以具有多个属性，这些属性定义了其权限并与客户端身份验证系统进行交互。

1. 登录权限

&emsp;&emsp;只有具有`LOGIN`属性的角色才能连接到数据库服务器。创建具有登录权限的角色:

```sql
CREATE ROLE name LOGIN;
CREATE USER name;
```

&emsp;&emsp;CREATE USER 等同于附加 LOGIN 属性的 CREATE ROLE。

2. 密码

&emsp;&emsp;只有在要求用户在连接到数据库时提供密码时，密码才具有意义。数据库密码与操作系统密码是分开的，创建用户时指定密码：

```sql
CREATE ROLE name LOGIN PASSWORD 'string';
```

&emsp;&emsp;这里只介绍最常用的两个角色属性，更多属性参见官方文档 [Role Attributes](https://www.postgresql.org/docs/current/role-attributes.html)。

### 角色成员资格

&emsp;&emsp;为了方便管理权限，经常将用户分组，这样可以向整个组授予或撤销权限。在 PostgreSQL 中，这是通过创建一个代表该组的角色，然后向各个用户角色授予组角色中的成员资格来完成的。

&emsp;&emsp;首先创建一个代表组的角色，通常，用作组的角色不会有 LOGIN 属性：

```sql
CREATE ROLE name;
```

&emsp;&emsp;组角色存在后，使用`GRANT`和`REVOKE`命令向组中添加和删除成员：

```sql
GRANT group_role TO role1, ... ;
REVOKE group_role FROM role1, ... ;
```

&emsp;&emsp;成员角色有两种方式可以使用组角色的权限：继承组角色的权限并以自己的身份使用，或者暂时成为组角色然后以组角色的身份使用权限 (此时创建的任何数据库对象都被视为由组角色而不是成员角色拥有)。

```sql
GRANT group_role TO role [INHERIT TRUE, SET TRUE];
```

&emsp;&emsp;暂时成为组角色通过`SET`命令实现：

```sql
SET ROLE name;
```

&emsp;&emsp;以下任意一种方法都可以恢复原来的身份：

```sql
SET ROLE login_role;
SET ROLE NONE;
RESET ROLE;
```

### 删除角色

&emsp;&emsp;由于角色可以拥有数据库对象，并且可以持有访问其他对象的权限，因此删除角色通常不仅仅是快速`DROP ROLE`的问题。必须先删除或重新分配角色拥有的任何对象给其他所有者；并且必须撤销授予角色的任何权限。

&emsp;&emsp;可以使用`ALTER`命令逐个传输对象的所有权，例如：

```
ALTER TABLE bobs_table OWNER TO alice;
```

&emsp;&emsp;或使用`REASSIGN OWNED`命令将要删除角色所拥有的所有对象的所有权重新分配给另一个角色。由于 REASSIGN OWNED 无法访问其他数据库中的对象，因此必须在包含要删除角色所拥有对象的每个数据库中运行它。

&emsp;&emsp;一旦任何有价值的对象已转移给新所有者，便可以使用`DROP OWNED`命令删除要删除角色所拥有的任何剩余对象。同样，此命令无法访问其他数据库中的对象，因此必须在包含要删除角色所拥有对象的每个数据库中运行它。此外 DROP OWNED 不会删除整个数据库或表空间，因此如果角色拥有尚未转移给新所有者的任何数据库或表空间，则必须手动执行此操作。

&emsp;&emsp;DROP OWNED 还会负责删除授予目标角色的任何权限，这些权限用于不属于该角色的对象。由于 REASSIGN OWNED 不会触及此类对象，因此通常需要同时运行 REASSIGN OWNED 和 DROP OWNED (按此顺序!) 才能完全删除要删除角色的依赖项。

&emsp;&emsp;简而言之，删除用于拥有对象的某个角色的最通用方法是：

```sql
REASSIGN OWNED BY doomed_role TO successor_role;
DROP OWNED BY doomed_role;
-- repeat the above commands in each database of the cluster
DROP ROLE doomed_role;
```

&emsp;&emsp;如果并非所有拥有对象都转移给同一继承所有者，最好手动处理异常，然后执行上述步骤进行清理。如果在仍有依赖对象时尝试 DROP ROLE，它将发出消息，指出需要重新分配或删除哪些对象。
