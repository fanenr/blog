---
title: PostgreSQL 02 - 配置
date: 2024-07-23 14:00:00
updated: 2024-07-23 20:27:10
tags:
  - DB
  - PostgreSQL
categories:
  - [DB, PostgreSQL]
---

&emsp;&emsp;PostgreSQL: The World\'s Most Advanced Open Source Relational Database.

<!-- more -->

## 客户端身份验证

&emsp;&emsp;当客户端应用程序连接到数据库服务器时，它会指定希望以哪个 PostgreSQL 数据库用户名进行连接，这与用户以特定用户身份登录 Unix 计算机的方式非常相似。PostgreSQL 数据库用户名在逻辑上与服务器运行所在的操作系统的用户名分离。

### pg_hba.conf 文件

&emsp;&emsp;客户端认证由一个配置文件控制，传统上命名为`pg_hba.conf`，并存储在数据库集群的数据目录中。`pg_hba.conf`文件的一般格式是一组记录，每行一个记录。空白行将被忽略，`#`注释字符之后的任何文本也将被忽略。可以通过在行尾加上反斜杠来将记录续到下一行。每个认证记录指定一个连接类型、一个客户端 IP 地址范围 (如果与连接类型相关)、一个数据库名称、一个用户名以及用于匹配这些参数的连接的认证方法。

```
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            md5
# IPv6 local connections:
host    all             all             ::1/128                 md5
# Allow replication connections from localhost, by a user with the
# replication privilege.
local   replication     all                                     trust
host    replication     all             127.0.0.1/32            md5
host    replication     all             ::1/128                 md5
```

&emsp;&emsp;注释说的比较清晰，这里所说的 USER 是 PG 数据中有 LOGIN 权限的 ROLE，而不是系统用户。METHOD 字段用于控制客户端以该 USER 登录服务器时的验证方式：`trust`表示无需密码即可连接，如果要求客户端连接时输入 USER 的密码，则 METHOD 应为`password`，`md5`或`scram-sha-256`。但实际常用的方式应该是后两种，因为`password`会使密码以明文的形式被传递。

&emsp;&emsp;如果要求客户端输入密码，则 USER 的密码不能为 NULL，否则所有密码都无法通过验证。

### postgresql.conf 文件

&emsp;&emsp;postgresql.conf 是另一个重要的配置文件，它包含了很多配置项目，这里只列两条：

```
listen_addresses = 'localhost'          # what IP address(es) to listen on;
                                        # comma-separated list of addresses;
                                        # defaults to 'localhost'; use '*' for all
                                        # (change requires restart)
#port = 5432                            # (change requires restart)
```

&emsp;&emsp;这两个配置项用于控制服务器监听地址和端口，`localhost`表示 PG 只会监听本机地址，外部主机将无法连接服务器。将其修改为`*`以允许外部主机连接服务器。

## 角色

&emsp;&emsp;PostgreSQL 使用角色的概念管理数据库访问权限。根据角色的设置方式，可以将角色视为数据库用户或数据库用户组。角色可以拥有数据库对象 (如表和函数），并且可以将这些对象上的权限分配给其他角色，以控制谁可以访问哪些对象。

&emsp;&emsp;角色的概念包含了`用户`和`组`的概念。在 8.1 之前的 PostgreSQL 版本中，用户和组是不同类型的实体，但现在只有角色。任何角色都可以充当用户、组或两者。

### 管理角色

&emsp;&emsp;从概念上讲，数据库角色与操作系统用户完全分离。在实践中，保持对应关系可能很方便，但这并不是必需的。数据库角色在整个数据库集群安装中是全局的(而不是针对每个单独的数据库）。

1. 创建角色

```sql
CREATE ROLE name [LOGIN];
```

2. 删除角色

```sql
DROP ROLE name;
```

&emsp;&emsp;PG 提供了以上两个语句的 shell 包装器：

```bash
createuser name
dropuser name
```

3. 查询角色

&emsp;&emsp;查询数据库集群中现有的角色：

```sql
SELECT rolname FROM pg_roles;
```

&emsp;&emsp;查询有登录权限的角色：

```sql
SELECT rolname FROM pg_roles WHERE rolcanlogin;
```

&emsp;&emsp;查询角色也可以使用 PG 的元命令：

```sql
\du
```

