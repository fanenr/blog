---
title: APUE 10
date: 2023-10-27 17:01:57
tags:
    - APUE
    - C
categories:
    - APUE
---

&emsp;&emsp;信号是软件中断，它提供了一种处理异步事件的方法。

<!-- more -->

## 信号概念

&emsp;&emsp;每个信号都有一个名字，这些名字都以 SIG 开头。V7 有 15 种不同的信号，SVR4 和 4.4BSD 均有 31 种不同的信号，OS X 和 Linux 都支持 31 种信号。此外 POSIX 的实时扩展还支持另外的应用程序定义的信号，SUSv4 已经把实时信号接扩扩展移至基础规范说明中了。

&emsp;&emsp;在头文件 <signal.h> 中，信号名都被定义为正整数常量 (信号编号)，不存在编号为 0 的信号。

&emsp;&emsp;很多条件可以产生信号：

-   当用户按下某些终端建时，引发终端产生信号。
-   硬件产生信号：除数为 0，无效的内存引用等。这些条件由硬件检测到，并通知内核。然后内核为该条件发生时正在运行的进程产生适当的信号。
-   进程调用 kill(2) 函数将任意信号发送给另一个进程或进程组。能发送的要求是：接收信号的进程和发送信号的进程的所有者必须相同，或发送进程的所有者是 root 用户。
-   用户可用 kill(1) 命令将信号发送给其他进程，此命令只是 kill 函数的接口。
-   当内核通知一个进程发生了某些事件时，软件条件也可以产生信号。

&emsp;&emsp;信号是异步事件的经典实例，产生信号的事件对于进程来说是随机出现的。进程不能通过简单的测试某个变量来判断是否发生了一个信号，而是必须告诉内核：在某个信号发生时，执行一些操作。这个操作又被称为信号的处理或与信号相关的动作，它包含 3 类：

1.   忽略此信号

&emsp;&emsp;大多数信号都可使用这种方式进行处理，但有两种信号绝不能被忽略：SIGKILL 和 SIGSTOP。原因是：它们向内核或超级用户提供了终止进程的可靠方法，此外，如果忽略了某些由硬件产生的信号，则接下来进程运行的行为将是未定义的。

2.   捕捉信号

&emsp;&emsp;捕捉信号指：通知内核在发生某种信号时，调用一个用户函数。通过这种方式，用户可以针对某些事件做一些特殊的处理。但是，不能捕捉 SIGKILL 和 SIGSTOP 信号。

3.   执行系统默认动作

&emsp;&emsp;对于大多数信号而言，系统的默认动作是终止该进程，下面是每一种信号的默认动作：

![](01.png)

&emsp;&emsp;终止 + core 表示终止时在进程的当前工作目录生成一个 core 文件，core 文件中复制了该进程的内存映像和寄存器状态，可以使用调试工具 (gdb) 进一步分析进程终止的原因。

&emsp;&emsp;有 5 种情况不生成 core 文件：

1.   进程是设置用户 ID 的，而且当前用户并非可执行文件的所有者。
2.   进程是设置组 ID 的，而且当前用户并非可执行文件的组所有者。
3.   用户没有当前工作目录的写权限。
4.   文件已存在，而且用户对该文件没有写权限。
5.   文件太大。

## 函数 signal

&emsp;&emsp;UNIX 系统信号机制最简单的接口是 signal 函数：

```c
#include <signal.h>

void (*signal(int signo, void (*func)(int)))(int);

/* Returns: previous disposition of signal (see following) if OK, SIG_ERR on error */
```

&emsp;&emsp;signal 的函数签名比较复杂，可以简化如下：

```c
typedef void Sigfun(int);
Sigfunc *signal(int signo, Sigfunc *func);
```

&emsp;&emsp;参数 *signo* 是之前表中的信号名，*func* 可以是用户自定义函数地址或两个常量之一：SIG_IGN，SIG_DFL。如果指定 SIG_IGN，则向内核表示忽略此信号。如果指定 SIG_DFL，则表示接到此信号后的动作是系统默认动作。当指定自定义函数地址时，内核会在信号发生时调用该函数，这种处理被称为`捕捉信号`，此函数则被称为`信号处理程序` (signal handler) 或`信号捕捉函数` (signal-catching function)。

&emsp;&emsp;系统头文件 <signal.h> 中可能会包含以下定义：

```c
#define SIG_ERR  (void (*)())-1
#define SIG_DFL  (void (*)())0
#define SIG_IGN  (void (*)())1
```

&emsp;&emsp;signal 函数的返回值是指向之前信号处理程序的指针。

1.   程序启动

&emsp;&emsp;当使用 exec 函数执行一个新程序时，因为进程的正文段会被替换，所以之前设置的所有信号捕捉函数都将被重置为默认动作。但是，之前设置忽略的行为不会改变。

&emsp;&emsp;例如，在交互式 shell 中运行后台程序：

```bash
cc main.c &
```

&emsp;&emsp;shell 会将后台进程对中断和退出信号的处理方式设置为忽略。于是，按下中断字符时就不会影响到后台进程，如果不这么处理，当按下中断字符时，它不仅会终止前台进程，也会终止所有后台进程。

2.   进程创建

&emsp;&emsp;当一个进程调用 fork 时，其子进程继承父进程的信号处理方式。因为子进程在开始时复制了父进程的内存映像，所以信号处理函数地址在子进程中是有意义的。
